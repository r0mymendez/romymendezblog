---
title: "RabbitMQ-Pika"
description: |
  RabbitMQ permite gestionar colas de mensajes entre emisores y destinatarios, en el siguiente post vamos a utilizar en python **Pika** para su implementaci贸n.
categories:
  - Python
preview: "https://image.freepik.com/free-vector/landing-page-send-message-illustration_126608-31.jpg"
twitter:
  site: "@r0mymendez"
  creator: "@r0mymendez"
author:
  - name: Romina Mendez
    url: https://example.com/norajones
date: 09-10-2021
output:
  distill::distill_article:
    self_contained: yes
    toc: yes
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

![](https://i.ibb.co/4ZyFbqH/1200px-Rabbit-MQ-logo-svg.png)

## Introducci贸n: 驴Que es RabbitMQ?

[RabbitMQ](https://www.rabbitmq.com/) es un sistema intermediario dise帽ado para facilitar la transferencia de mensajes entre productores y consumidores a trav茅s de la implementaci贸n de colas.

Este componente, esencial en la arquitectura de sistemas distribuidos, se basa en conceptos clave:

1.  **Productor:** La entidad encargada de originar y enviar mensajes.
2.  **Cola:** Un reservorio donde los mensajes se almacenan temporalmente.
3.  **Consumidor:** La instancia receptora que procesa los mensajes seg煤n la necesidad del sistema.

Esta introducci贸n busca proporcionar una visi贸n clara y concisa de los elementos fundamentales de RabbitMQ, allanando el camino para una comprensi贸n m谩s profunda de su funcionamiento en entornos de mensajer铆a.

![](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vz2hrw3kb99b4b6bof5q.png)

------------------------------------------------------------------------

## Implementaci贸n con Pika en Python 

La implementaci贸n en Python con la librer铆a Pika implica la creaci贸n de dos programas esenciales: el **productor** y el **consumidor**.

**`Pika`** proporciona una interfaz eficaz para la comunicaci贸n con RabbitMQ, aprovechando un conjunto de objetos cuidadosamente dise帽ados para este prop贸sito.

En nuestro ejemplo pr谩ctico, imaginemos el productor como una aplicaci贸n dise帽ada para gestionar pedidos de entrega de alimentos .
Esta aplicaci贸n, cuyo objetivo es optimizar el proceso de entrega, se encarga de enviar m煤ltiples mensajes relacionados con los pedidos realizados por los usuarios .

Para lograr esta implementaci贸n, abordaremos los siguientes pasos:

+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Pasos                 | Descripci贸n                                                                                                                                                                                                                                            |
+=======================+========================================================================================================================================================================================================================================================+
| **Productor:**        | Desarrollar un programa que, como un eficiente tomador de pedidos, genere y env铆e mensajes a la cola de RabbitMQ. Estos mensajes contendr谩n informaci贸n valiosa sobre los pedidos de comida.                                                          |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| **Consumidor:**       | Crear un programa que act煤e como el receptor de estos mensajes en la cola. El consumidor estar谩 encargado de procesar estos mensajes seg煤n las necesidades del sistema, realizando las acciones pertinentes, como gestionar la entrega de los pedidos. |
+-----------------------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

Este enfoque estructurado y eficiente garantiza una implementaci贸n clara y funcional, proporcionando una base s贸lida para sistemas que gestionan flujos de informaci贸n en entornos din谩micos.

------------------------------------------------------------------------

### 1. Instalar pika

`!pip install pika`

------------------------------------------------------------------------

### 2. Generar el script `send.py` 

``` {.python}
import pika
from datetime import datetime

connection = pika.BlockingConnection(
    pika.ConnectionParameters(host='localhost'))
channel = connection.channel()

channel.queue_declare(queue='delivery')

pedidos=['','','梆梆','吼吼']

for i in pedidos:
    channel.basic_publish(exchange='', routing_key='delivery', body=i)
    print(" [x] Se envia pedido!'"+ i)

connection.close()
```

------------------------------------------------------------------------

### 3. Generar el script `receive.py` 

``` {.python}
import pika, sys, os
from datetime import datetime


def main(queue='delivery'):
    connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
    channel = connection.channel()
    channel.queue_declare(queue=queue)

    def callback(ch, method, properties, body):
        print(" [x] Received %r" % body.decode())

    channel.basic_consume(queue='delivery', on_message_callback=callback, auto_ack=True)

    print(' [*] Waiting for messages. To exit press CTRL+C')
    channel.start_consuming()

if __name__ == '__main__':
    try:
        main(queue=queue)
    except KeyboardInterrupt:
        print('Interrupted')
        try:
            sys.exit(0)
        except SystemExit:
            os._exit(0)
```

------------------------------------------------------------------------

![Image description](https://dev-to-uploads.s3.amazonaws.com/uploads/articles/q1ag2ri7ygsv2vgf1r6z.png)

------------------------------------------------------------------------

## Mongodb + Pika

A continuaci贸n vamos a modificar el script para que pueda conectarse a un mongodb atlas y realice el insert de los mensajes recibidos.

``` {.python}
import pymongo
import pika, sys, os
from datetime import datetime

# Crear una conexion con MongoClient
client = pymongo.MongoClient("mongodb+srv://NombreUser:PasswordUser@clusterName.moczg.mongodb.net/rabbit?retryWrites=true&w=majority")

# Database
db = client["rabbit"]

# Collection
collection= db["mensajes"]

def main(queue='delivery'):
    connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
    channel = connection.channel()
    channel.queue_declare(queue=queue)

    def callback(ch, method, properties, body):
        print(" [x] Received %r" % body.decode())
        body_indsert={'fecha':datetime.now(),'queue':queue,'message':body.decode()}
        db["mensajes"].insert_one(body_indsert)

    channel.basic_consume(queue='hello', on_message_callback=callback, auto_ack=True)

    print(' [*] Waiting for messages. To exit press CTRL+C')
    channel.start_consuming()

if __name__ == '__main__':
    try:
        main(queue=queue)
    except KeyboardInterrupt:
        print('Interrupted')
        try:
            sys.exit(0)
        except SystemExit:
            os._exit(0)
```

------------------------------------------------------------------------

Para descargar el c贸digo de estos dos archivos puedes hacerlo desde el siguiente [link](https://gist.github.com/r0mymendez/3ae8a0c63b1d624e438ba472ff68c3aa)

------------------------------------------------------------------------

Para conocer m谩s de Rabbitmq puedes ver los siguientes sitios:

-    [Documentaci贸n Oficial](https://www.rabbitmq.com/documentation.html) con el [Tutorial](https://www.rabbitmq.com/getstarted.html)

-    [Pika](https://pika.readthedocs.io/en/stable/)
